<!DOCTYPE HTML>
<html>
<head>
    <title>Bikesoft for EZ-Alarm</title>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
    <!-- 引入 Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <!-- 您的自定义样式 -->
    <link rel="stylesheet" href="assets/css/main.css" />
</head>
<body>

    <!-- 地图容器 -->
    <div id="map" style="width: 100%; height: 100vh;"></div>

    <!-- 引入必要的脚本 -->
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <!-- 您的自定义脚本 -->
    <script>
        // 初始化地图，并设置初始视图
        var map = L.map('map').setView([0, 0], 2);

        // 添加地图瓦片层
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors',
            noWrap: true
        }).addTo(map);

        // 初始化标记数组和轨迹线
        window.markers = [];
        window.polyline = null;
        window.predictedMarker = null;

        // 定义红色标记图标
        var redIcon = new L.Icon({
            iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png',
            shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.7.1/images/marker-shadow.png',
            iconSize: [25, 41],
            iconAnchor: [12, 41],
            popupAnchor: [1, -34],
            shadowSize: [41, 41]
        });

        // 定义更新位置的函数
        async function updateLocation() {
            try {
                const response = await fetch('https://bikesoft-backend.onrender.com/location'); // 替换为您的后端服务器 URL
                if (response.ok) {
                    const result = await response.json();
                    const data = result.locations;
                    const predictedLocation = result.predictedLocation;

                    if (data.length > 0) {
                        // 清除现有的标记和轨迹
                        if (window.markers) {
                            window.markers.forEach(marker => map.removeLayer(marker));
                        }
                        if (window.polyline) {
                            map.removeLayer(window.polyline);
                        }
                        if (window.predictedMarker) {
                            map.removeLayer(window.predictedMarker);
                        }

                        // 初始化标记数组和坐标数组
                        window.markers = [];
                        const coordinates = [];

                        data.forEach(location => {
                            const { latitude, longitude, timestamp } = location;
                            const latlng = [latitude, longitude];
                            coordinates.push(latlng);

                            // 创建标记并添加到地图
                            const marker = L.marker(latlng).addTo(map);
                            marker.bindPopup(`Time: ${new Date(timestamp).toLocaleString()}`);
                            window.markers.push(marker);
                        });

                        // 绘制轨迹线
                        window.polyline = L.polyline(coordinates, { color: 'blue' }).addTo(map);

                        // 显示预测的点位
                        if (predictedLocation) {
                            const { latitude, longitude, timestamp } = predictedLocation;
                            window.predictedMarker = L.marker([latitude, longitude], { icon: redIcon }).addTo(map);
                            window.predictedMarker.bindPopup(`Predicted Time: ${new Date(timestamp).toLocaleString()}`);
                        }

                        // 调整地图视野以适应所有标记
                        const group = new L.featureGroup([...window.markers, window.predictedMarker]);
                        map.fitBounds(group.getBounds());
                    } else {
                        console.error('No location data available.');
                    }
                } else {
                    console.error('Error fetching location data.');
                }
            } catch (error) {
                console.error('Error fetching location:', error);
            }
        }

        // 初次加载时调用
        updateLocation();

        // 每隔 30 秒更新一次位置
        setInterval(updateLocation, 30000);
    </script>
</body>
</html>
